<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard CAT - Dptales Norte</title>

<style>
:root{
  --panel:#fff;
  --border:rgba(0,0,0,.06);
  --shadow:0 10px 35px rgba(0,0,0,.06);
  --teal1:#0aa3a8;
  --teal2:#40c3c7;
  --teal3:#0b7e86;
  --muted:#6d7c85;
  --orange:#c8821f;
  --lime:#6a8d2a;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(circle at 20% 0%, #f3f5f6, #ffffff 55%);
  color:#20323a;
}
.page{
  max-width:1180px;
  margin:28px auto;
  padding:18px;
  display:grid;
  grid-template-columns:420px 1fr;
  gap:22px;
}
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:18px 18px 14px;
}
.panel-title{
  font-weight:650;
  font-size:22px;
  padding:6px 6px 12px;
}
.panel-foot{
  display:flex;align-items:center;gap:10px;
  margin-top:12px;padding:6px;color:var(--muted);font-size:13px;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:linear-gradient(135deg,var(--teal2),var(--teal1));
  box-shadow:0 0 0 4px rgba(10,163,168,.12);
}
.urd-list{display:flex;flex-direction:column;gap:10px;padding:6px;}
.urd-row{display:grid;grid-template-columns:28px 1fr;gap:10px;align-items:center;}
.urd-ico{width:26px;height:26px;display:grid;place-items:center;border-radius:10px;color:var(--teal1);}
.urd-ico svg{width:22px;height:22px;fill:currentColor;}
.urd-bar{
  position:relative;height:44px;border-radius:12px;background:#f2f6f6;overflow:hidden;
  border:1px solid rgba(0,0,0,.04);
}
.urd-fill{
  position:absolute;inset:0 auto 0 0;width:0%;
  background:linear-gradient(90deg, rgba(64,195,199,.55), rgba(10,163,168,.95));
  border-radius:12px;transition:width .6s ease;
}
.urd-meta{
  position:relative;z-index:2;height:100%;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;
}
.urd-name{font-size:20px;font-weight:600;color:#22343c;}
.urd-val{
  font-size:22px;font-weight:800;color:#fff;padding:6px 10px;border-radius:10px;
  background:rgba(0,0,0,.18);
}
.urd-top .urd-name{font-size:24px;}

.header{padding:2px 6px 10px;}
.h1{font-size:26px;font-weight:750;}
.h1 .muted{font-weight:650;color:#3b4b53;}
.h2{margin-top:4px;font-size:14px;color:var(--muted);}
.rule{height:4px;border-radius:99px;margin-top:12px;background:linear-gradient(90deg, rgba(10,163,168,1), rgba(10,163,168,.1));}
.grid{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.kpi{
  border-radius:14px;border:1px solid rgba(0,0,0,.06);padding:14px;
}
.kpi-strong{background:linear-gradient(135deg, rgba(10,163,168,.95), rgba(64,195,199,.75));color:#fff;}
.kpi-soft{background:linear-gradient(135deg, #eaf7f3, #dff1ea);}
.kpi-white{background:linear-gradient(135deg, #f7fafb, #eef4f5);}
.kpi-cream{background:linear-gradient(135deg, #f6f4ea, #f2f0e3);}
.kpi-label{font-size:18px;font-weight:650;}
.kpi-value{margin-top:10px;font-size:54px;font-weight:850;}
.kpi-value-dark{color:#11434a;}
.status{margin-top:12px;padding:10px;border-radius:12px;border:1px dashed rgba(0,0,0,.12);color:var(--muted);font-size:13px;}
@media(max-width:980px){.page{grid-template-columns:1fr;}}
</style>
</head>

<body>
<div class="page">

<section class="panel">
<div class="panel-title">Controles por URD</div>
<div id="urdList" class="urd-list"></div>
<div class="panel-foot">
<span class="dot"></span>
<span id="leftNote">Actualizando‚Ä¶</span>
</div>
</section>

<section class="panel">
<div class="header">
<div class="h1">Controles con m√≥viles ‚Äì <span class="muted">Resultados CAT</span></div>
<div id="subtitle" class="h2">DIR. GRAL. DPTALES NORTE</div>
<div class="rule"></div>
</div>

<div class="grid">
<div class="kpi kpi-strong">
<div class="kpi-label">Controles</div>
<div id="kpiControles" class="kpi-value">‚Äî</div>
</div>

<div class="kpi kpi-soft">
<div class="kpi-label">Positivos</div>
<div id="kpiPositivos" class="kpi-value kpi-value-dark">‚Äî</div>
</div>

<div class="kpi kpi-white">
<div class="kpi-label">Tasa positivos</div>
<div id="kpiTasa" class="kpi-value kpi-value-dark">‚Äî</div>
</div>
</div>

<div id="status" class="status">Cargando datos‚Ä¶</div>
</section>
</div>

<script>
const CONFIG = {
SHEET_ID: "1iKuO0d3x3XVcEYWJfvisvDh5CFAOPEp0mOX-phByw00",
SHEET_NAME: "Hoja 1"
};

const $ = (s) => document.querySelector(s);

function norm(v){
return String(v ?? "").trim().toUpperCase();
}
function toNumber(v){
const n=parseFloat(String(v).replace(/\./g,"").replace(/,/g,"."));
return Number.isFinite(n)?n:0;
}
function formatInt(n){ return new Intl.NumberFormat("es-AR").format(Math.round(n||0)); }
function formatPct(n){
return new Intl.NumberFormat("es-AR",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0)+"%";
}

function buildUrl(){
return `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json`;
}

async function fetchRows(){
const res=await fetch(buildUrl(),{cache:"no-store"});
const text=await res.text();
const jsonStr=text.substring(text.indexOf("{"),text.lastIndexOf("}")+1);
const data=JSON.parse(jsonStr);
return (data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:null));
}

function renderURD(items){
const host=$("#urdList");
host.innerHTML="";
const max=Math.max(...items.map(x=>x.value));
items.forEach((it,idx)=>{
const pct=max?(it.value/max)*100:0;
const row=document.createElement("div");
row.className="urd-row"+(idx===0?" urd-top":"");
row.innerHTML=`
<div class="urd-ico">üè¢</div>
<div class="urd-bar">
<div class="urd-fill" style="width:${pct}%;"></div>
<div class="urd-meta">
<div class="urd-name">${it.name}</div>
<div class="urd-val">${formatInt(it.value)}</div>
</div>
</div>`;
host.appendChild(row);
});
}

(async function main(){
try{
$("#status").textContent="Cargando datos‚Ä¶";
const rows=await fetchRows();

let items=[];
let total={controles:0,positivos:0};

rows.forEach(r=>{
if(!r[0] || norm(r[0])==="DEPARTAMENTAL") return;
if(norm(r[0])==="TOTAL"){
total.controles=toNumber(r[1]);
total.positivos=toNumber(r[2]);
return;
}
items.push({
dept:r[0],
controles:toNumber(r[1]),
positivos:toNumber(r[2])
});
});

$("#kpiControles").textContent=formatInt(total.controles);
$("#kpiPositivos").textContent=formatInt(total.positivos);
$("#kpiTasa").textContent=formatPct(total.controles?(total.positivos/total.controles)*100:0);

renderURD(
items
.sort((a,b)=> b.controles - a.controles)
.map(x=>({name:x.dept,value:x.controles}))
);

const now=new Date();
$("#leftNote").textContent=`Fuente: Google Sheet ¬∑ ${now.toLocaleTimeString("es-AR",{hour12:false})}`;
$("#status").textContent="OK";

}catch(e){
$("#status").textContent="ERROR: "+e.message;
}
})();
</script>
</body>
</html>
